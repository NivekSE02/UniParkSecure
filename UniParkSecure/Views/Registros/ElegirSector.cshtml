@{
    ViewData["Title"] = "Elegir Sector";
    var email = Context.Request.Query["email"].ToString();
    ViewBag.Email = email;
}

<style>
    .dashboard-content {
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
    }

    .sector-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }

    .sector-btn {
        padding: 20px;
        font-size: 1.1rem;
        font-weight: 600;
        color: white;
        background: #0d6efd;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .sector-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            background: #0b5ed7;
        }

    .mensaje {
        padding: 15px;
        margin: 20px 0;
        border-radius: 8px;
        text-align: center;
        font-weight: 500;
    }

        .mensaje.error {
            background-color: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .mensaje.success {
            background-color: #dcfce7;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }

        .mensaje.loading {
            background-color: #e0f2fe;
            color: #0284c7;
            border: 1px solid #bae6fd;
        }
</style>

<div class="dashboard-content">
    <h2 class="text-2xl font-bold mb-6">¿A qué sector se dirige?</h2>
    <p class="text-gray-600 mb-4">Email: @ViewBag.Email</p>

    <div class="sector-grid">
        <button onclick="registrarEntrada(1, 'Biblioteca 1')" class="sector-btn">Biblioteca 1</button>
        <button onclick="registrarEntrada(3, 'Biblioteca 2')" class="sector-btn">Biblioteca 2</button>
        <button onclick="registrarEntrada(2, 'Colegio')" class="sector-btn">Colegio</button>
        <button onclick="registrarEntrada(4, 'Edificio A')" class="sector-btn">Edificio A</button>
        <button onclick="registrarEntrada(5, 'Edificio B')" class="sector-btn">Edificio B</button>
        <button onclick="registrarEntrada(6, 'Edificio C')" class="sector-btn">Edificio C</button>
        <button onclick="registrarEntrada(7, 'Edificio E')" class="sector-btn">Edificio E</button>
        <button onclick="registrarEntrada(8, 'Edificio G')" class="sector-btn">Edificio G</button>
    </div>

    <div id="mensaje"></div>
</div>

<script>
    function showMessage(text, type = 'loading') {
        const msgDiv = document.getElementById('mensaje');
        msgDiv.className = `mensaje ${type}`;
        msgDiv.textContent = text;
    }

    async function registrarEntrada(sectorId, sectorNombre) {
        const email = '@ViewBag.Email';
        if (!email) {
            showMessage('Error: Email no proporcionado', 'error');
            return;
        }

        showMessage(`Registrando entrada a ${sectorNombre}...`, 'loading');

        const buttons = document.querySelectorAll('.sector-btn');
        buttons.forEach(btn => btn.disabled = true);

        try {
            const response = await fetch('/Registros/CreateEntrada', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: email,
                    sectorId: sectorId
                })
            });

            const data = await response.json();
            console.log('Respuesta:', data); // Para depuración

            if (response.ok && data.mensaje && !data.mensaje.toLowerCase().includes("error")) {
                showMessage(data.mensaje, 'success');
                setTimeout(() => {
                    // Redirigir a DashboardEntrada (anteriormente DashboardCam)
                    window.location.href = '/Home/DashboardEntrada?sectorId=' + sectorId + '&email=' + encodeURIComponent(email);
                }, 1200);
            } else {
                showMessage(data.mensaje || 'Error al registrar entrada', 'error');
                buttons.forEach(btn => btn.disabled = false);
            }
        } catch (error) {
            console.error('Error:', error);
            showMessage('Error de conexión. Por favor, intente de nuevo.', 'error');
            buttons.forEach(btn => btn.disabled = false);
        }
    }
</script>
